<?php	namespace Account\Model;	use Account\Form\ForgotPasswordForm;	use Account\Form\LoginForm;	use Application\Controller\DB;	use Application\Controller\Security;	use Zend\Authentication\Storage\Session;	use Zend\Db\Adapter\Adapter;	use Zend\Db\Adapter\Platform\Mysql;	use Zend\Http\Header\UserAgent;	use Zend\Http\Request;	use Zend\Http\Client;	use Zend\Session\Container as SessionContainer;	use Zend\Mail;	use Zend\Mime\Message as MimeMessage;	use Zend\Mime\Part as MimePart;	class LoginTable	{		protected $db;		public $AccountID;		public $Security;		public function __construct(){			$this->db = new DB();			$this->Security = new Security();		}		public function loginModel(LoginForm $loginForm)		{			$email = $loginForm->get('username')->getValue();			$password = $loginForm->get('password')->getValue();			if ($email=='' || $password==''){				return false;			}			$password = $this->Security->hashText($password); 			$db = new DB('webselect');			$output = $db->query("SELECT * FROM user WHERE email=? and password=?", array($email, $password));			$output = $output->current();			$this->Security->createUserSession('');			if ($output){				$this->Security->createUserSession($output,'create');			}			return $output;		}		public function insertForgotPasswordTokenModel($email)		{			$user_agent = $_SERVER['HTTP_USER_AGENT'];			$auth = rand(0,1000).str_shuffle('T0SH8M1T05V').rand(0,10000);			$auth_created =  date('Y-m-d h:i:s');			$db = new DB('webupdate');			$output = $db->query("UPDATE user SET				auth='".$auth."',				auth_created='".$auth_created."',				auth_user_agent='".$user_agent."'				WHERE email = ?", array($email));			$output = $output->getAffectedRows();			return $output;		}		public function registerModel(){			$password = $this->Security->hashText('coming soon');		}		public function forgotPasswordModel(ForgotPasswordForm $forgotPasswordForm){			$email = $forgotPasswordForm->get('username')->getValue();			$url = $forgotPasswordForm->get('url')->getValue();			$request = "forgot_password";			$db = new DB('webselect');			$output = $db->query("SELECT user_id, auth FROM user WHERE email=?", array($email));			$output = $output->current();			$user_id = (int) $output['user_id'];			$auth = $output['auth'];			if ($user_id>0){				$isTokenInserted = $this->insertForgotPasswordTokenModel($email);				if ($isTokenInserted!==1){					return false;				}				return $isEmailSent = $this->sendEmail($email, $auth, $request, $url);				if ($isEmailSent==NULL){					return true;				}				return false;			}			return false;		}		public function sendEmail($email, $auth, $request, $url){			$url .='?email='.$email."&auth=".$auth;			$body = "Hello, <br />			Please click <a href='{$url}'>here</a> to change your password. <br />			Thank you, <br />			Toshmatov.us Admin";			$htmlPart = new MimePart($body);			$htmlPart->type = "text/html";			$textPart = new MimePart($body);			$textPart->type = "text/plain";			$body = new MimeMessage();			$body->setParts(array($textPart, $htmlPart));			$message = new Mail\Message();			$message->setFrom('jon@toshmatov.us');			$message->addTo($email);//			$message->addReplyTo($reply);//			if ($cc)//				$message->addCc($cc);//			if ($bcc)//				$message->addBcc($bcc);			$message->setSender('Jon Toshmatov');			$message->setSubject('Forgot My Password');			$message->setEncoding("UTF-8");			$message->setBody($body);			$message->getHeaders()->get('content-type')->setType('multipart/alternative');			$transport = new Mail\Transport\Sendmail();			return $transport->send($message);		}	}